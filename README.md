# ConvNext Kidney Analysis

This project uses a ConvNext model to classify kidney tissue patches as normal, sclerotic, or background.

## Project Overview

This is a kidney glomeruli analysis system that uses ConvNeXt for 3-class classification of WSI (Whole Slide Image) patches:
- **Normal glomeruli** (class 0)
- **Sclerotic glomeruli** (class 1) 
- **Background tissue** (class 2)

The system processes SVS files and polygon annotations to train a deep learning model for automated glomerular pathology detection.

## Project Structure

- `extract_patches.py`: Extracts patches from whole-slide images (`.svs` files) and their corresponding annotations (`.geojson` files). It creates a balanced dataset of normal, sclerotic, and background patches.
- `dataset.py`: Defines the PyTorch `Dataset` and `DataLoader` for loading the extracted patches. It includes data augmentation for the training set.
- `model.py`: Defines the ConvNext-based classifier.
- `train.py`: Trains the model on the extracted patches.
- `test_patch_extraction.py`: A script to visualize the patch extraction process for debugging and verification.
- `analyze_class_balance.py`: Analyzes the class balance in the annotated dataset.
- `requirements.txt`: Contains the necessary Python packages to run the project.

## Setup

1.  **Install dependencies:**
    ```bash
    pip install -r requirements.txt
    ```

2.  **Data:**
    - Place your whole-slide images (`.svs`) in the `data/raw images` directory.
    - Place your GeoJSON annotations in the `data/geoJson annotations` directory.

## Usage

1.  **Extract Patches:**
    ```bash
    python extract_patches.py
    ```
    This will create a `patches` directory with subdirectories for each class and a `train_patches.txt` file listing the paths to the extracted patches and their corresponding labels.

2.  **Train the Model:**
    ```bash
    python train.py
    ```
    This will train the ConvNext model and save the best-performing model to the `checkpoints` directory.

3.  **Test Patch Extraction (Optional):**
    ```bash
    python test_patch_extraction.py
    ```
    This will generate visualizations of the patch extraction process, which can be found in the `visualization_outputs` directory.

4.  **Analyze Class Balance (Optional):**
    ```bash
    python analyze_class_balance.py
    ```
    This will print a report on the class balance in your dataset.

## Key Commands

### Setup and Dependencies
```bash
pip install -r requirements.txt
```

### Data Analysis and Preparation
```bash
# Analyze class distribution across all annotations
python analyze_class_balance.py

# Test patch extraction with visualization (10 samples per class)
python test_patch_extraction.py

# Full patch extraction for training (creates train_patches.txt)
python extract_patches.py --target_per_class 1013 --target_size 512
```

### Model Training
```bash
# Train with default settings (batch_size=16, epochs=50)
python train.py

# Train with custom parameters
python train.py --batch_size 32 --epochs 100 --lr 1e-4 --num_workers 8
```

## Architecture Overview

### Data Pipeline
1. **Input**: SVS files (whole slide images) + GeoJSON polygon annotations
2. **Patch Extraction**: Adaptive sizing algorithm extracts complete glomerular morphology
3. **Preprocessing**: Patches resized to 512x512 with data augmentation
4. **Training**: Balanced 3-class dataset with equal samples per class

### Core Components

**extract_patches.py**: Implements adaptive patch extraction algorithm
- Uses bounding box analysis to determine optimal patch size
- Applies `max(512, bbox_size * 1.2)` sizing with 20% padding
- Background filtering prevents slide margin contamination
- Resizes all patches to 512x512 for model compatibility

**model.py**: ConvNeXt-Tiny backbone with custom 3-class head
- ImageNet pre-trained weights for transfer learning
- LayerNorm + Linear classifier for medical domain adaptation

**dataset.py**: PyTorch dataset with medical image augmentations
- Random flips, rotations, color jittering for robustness
- ImageNet normalization for pre-trained model compatibility

**train.py**: Mixed precision training loop
- Automatic GPU/CPU detection and optimization
- Per-class accuracy tracking for medical evaluation
- Best model checkpointing based on validation accuracy

### Data Structure

```
data/
├── raw images/          # TPATH*.svs files
└── geoJson annotations/ # TPATH*.geojson polygon annotations

patches/                 # Generated by extract_patches.py
├── normal/
├── sclerotic/
└── background/

train_patches.txt        # Patch paths with labels for training
```

### Critical Design Decisions

**Adaptive Patch Sizing**: Normal glomeruli vary significantly in size. The system uses adaptive sizing to capture complete morphological structures rather than fragments, then resizes to consistent 512x512 for neural network compatibility.

**Class-Specific Filtering**: White background detection is applied only to background patches to avoid slide margins, while preserving legitimate white regions in normal glomeruli (important pathological feature).

**Balanced Sampling**: Uses exactly 1013 samples per class to prevent class imbalance bias in medical classification.

## Development Notes

The `visualization_outputs/` directory contains development history and patch extraction visualizations. The `development_process.txt` file documents the iterative refinement of the patch extraction algorithm.

When modifying patch extraction, always test with `test_patch_extraction.py` first to visualize results before running full extraction on 130+ WSI slides.